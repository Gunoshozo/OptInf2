# x * exp(-1j*2*x)
#   –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ - —Ñ–∏–Ω–∏—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
#   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤-–≤–∞ –§—É—Ä—å–µ
'''
1.–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–¥–Ω–æ–º–µ—Ä–Ω–æ–µ —Ñ–∏–Ω–∏—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –§—É—Ä—å–µ —Å –ø–æ–º–æ—â—å—é –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
–∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ë–ü–§
2.–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –≥–∞—É—Å—Å–æ–≤–∞ –ø—É—á–∫–∞ exp(‚àíùë†ùë•^2), s ‚Äì –∑–∞–¥–∞–≤–∞–µ–º–∞—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞. –ó–¥–µ—Å—å –∏ –¥–∞–ª–µ–µ –¥–ª—è
–∫–∞–∂–¥–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ —Å–ª–µ–¥—É–µ—Ç —Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –≥—Ä–∞—Ñ–∏–∫–∏ –∞–º–ø–ª–∏—Ç—É–¥—ã –∏ —Ñ–∞–∑—ã
3.–£–±–µ–¥–∏—Ç—å—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è, –ø–æ–¥–∞–≤ –Ω–∞ –≤—Ö–æ–¥ –≥–∞—É—Å—Å–æ–≤ –ø—É—á–æ–∫ exp(‚àíùë†ùë•^2)
‚Äì —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –§—É—Ä—å–µ. –ù–∞ –≤—ã—Ö–æ–¥–µ —Ç–æ–∂–µ –¥–æ–ª–∂–µ–Ω
–ø–æ–ª—É—á–∏—Ç—å—Å—è –≥–∞—É—Å—Å–æ–≤ –ø—É—á–æ–∫, –Ω–æ –¥—Ä—É–≥–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞ (–ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π
–æ–±–ª–∞—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è [‚àíùëèÃÉ, ùëèÃÉ]). –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –≤—Ö–æ–¥–Ω–∞—è –æ–±–ª–∞—Å—Ç—å: [‚àíùëé, ùëé] = [‚àí5, 5]
4.–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–∏–Ω–∏—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –§—É—Ä—å–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –º–µ—Ç–æ–¥–æ–º —á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ
–∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–µ—Ç–æ–¥–æ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤). –í–∞–∂–Ω–æ: –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
–≤—ã—á–∏—Å–ª–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞–ª –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∏—Å–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è u, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
–≤ –≤–∏–¥–µ –≤–µ–∫—Ç–æ—Ä–∞. –ù–∞ –≤—Ö–æ–¥ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤–Ω–æ–≤—å —Å–ª–µ–¥—É–µ—Ç –ø–æ–¥–∞–≤–∞—Ç—å –≥–∞—É—Å—Å–æ–≤ –ø—É—á–æ–∫.
5. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –Ω–∞ –æ–¥–Ω–æ–º
–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ (–æ–¥–Ω–æ –¥–ª—è –∞–º–ø–ª–∏—Ç—É–¥—ã, –æ–¥–Ω–æ –¥–ª—è —Ñ–∞–∑—ã) –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç.
6. –ò—Å–ø–æ–ª—å–∑—É—è –ø–µ—Ä–≤—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è, –ø–æ–¥–∞—Ç—å –Ω–∞ –≤—Ö–æ–¥ —Å–≤–µ—Ç–æ–≤–æ–µ –ø–æ–ª–µ,
–æ—Ç–ª–∏—á–Ω–æ–µ –æ—Ç –≥–∞—É—Å—Å–æ–≤–∞ –ø—É—á–∫–∞, –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å–æ —Å–≤–æ–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏
—Å–∞–º–æ–≥–æ –ø—É—á–∫–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è.
7. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Å–≤–æ–µ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–æ–ª—è –∏
–ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ –æ–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º, –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –≤
–ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø—É–Ω–∫—Ç–µ
8. –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—É–Ω–∫—Ç—ã 1-3 –∏ 6-7 –¥–ª—è –¥–≤—É–º–µ—Ä–Ω–æ–≥–æ —Å–ª—É—á–∞—è. –ì—Ä–∞—Ñ–∏–∫–∏ –∏–∑–º–µ–Ω—è—Ç—Å—è –Ω–∞
–¥–≤—É–º–µ—Ä–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –æ–¥–Ω–æ–º–µ—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–ª–µ–¥—É–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –¥–≤—É–º–µ—Ä–Ω—ã–µ,
—Ä–∞–≤–Ω—ã–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –æ–¥–Ω–æ–º–µ—Ä–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π. –ù–∞–ø—Ä–∏–º–µ—Ä, –≥–∞—É—Å—Å–æ–≤
–ø—É—á–æ–∫ –ø–æ–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ exp(‚àíùë†ùë•^2‚àíùëùùë¶^2), s, p ‚Äì –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã.
'''

import numpy as np
from mpl_toolkits import mplot3d
import matplotlib.pyplot as plt

a = 5
N = 2 ** 10
M = 2 ** 13
b = np.square(N) / (4 * a * M)
hx = a * 2 / N
hF = b * 2 / N
s = 1
p = 1


def fin_fft_2d(hx, f):
    f = add_zeros_1d(f, M)
    f = np.fft.fftshift(f)
    F = np.fft.fft(f)
    F = F * hx
    F = np.fft.fftshift(F)
    F = get_central_part_1d(F)
    return F


def fin_fft_3d(hx, zf):
    f = add_zeros_2d(zf, M)
    f = np.fft.fftshift(f)
    F = np.fft.fft2(f)
    F = F * (hx ** 2)
    F = np.fft.fftshift(F)
    F = get_central_part_2d(F)
    return F


def core_2d(Xi, x):
    return np.exp(-2j * np.pi * x * Xi)


def int_fourier_2d(X, Xi, h, func):
    A = core_2d(Xi[:, None], X[None, :])
    f = func(X)
    res = np.dot(A, f) * h
    return res


def int_fourier_3d(X, Xi, h, func):
    A = core_2d(Xi[:, None], X[None, :])
    f = func(X)
    res = np.dot(A, f) * h
    res1 = np.copy(res)
    return np.dot(res[:, None], res1[None, :])


def gaussian(x):
    return np.array(np.exp(-s * np.square(x)), dtype=np.complex)


def input_field_2d(x):
    return x * np.exp(-2j * x)


def gaussian_3d(x1, x2):
    return np.exp(-s * np.square(x1) - p * np.square(x2))


def input_field_3d(x, y):
    return x * y * np.exp(-2j * (x + y))


def input_of_size(a, N):
    x = np.linspace(-a, a, N)
    return input_field_2d(x)


def add_zeros_1d(x, M: int):
    l = (M - N) // 2
    r = l + N
    res = np.pad(x, (l, l), 'constant', constant_values=(0, 0))
    return res


def add_zeros_2d(x, M: int):
    l = (M - N) // 2
    r = l + N
    res = np.pad(x, ((l, l), (l, l)), 'constant', constant_values=((0, 0), (0, 0)))
    return res


def get_central_part_1d(x):
    M = len(x)
    l = (M - N) // 2
    r = l + N
    return x[l:r]


def get_central_part_2d(x):
    l = (M - N) // 2
    r = l + N
    return x[l:r, l:r]


def swap_halves_1d(x):
    N = len(x)
    N_2 = N // 2
    assert N % 2 == 0
    assert N_2 % 2 == 0
    t = np.copy(x)
    x[:N_2] = t[N_2:]
    x[N_2:] = t[:N_2]
    return x

def swap_halves_2d(x):
    N_2 = len(x)//2
    t = np.copy(x)
    a = np.zeros((len(x),len(x)),dtype=np.complex)
    a[:N_2,:N_2] = t[N_2:,N_2:]
    a[N_2:,:N_2] = t[:N_2,N_2:]
    a[N_2:,N_2:] = t[:N_2,:N_2]
    a[:N_2,N_2:] = t[N_2:,:N_2]
    return a


def plot_all_2D(x, y):
    fig1 = plt.figure(1)
    labels = ["—á–µ—Ä–µ–∑ –ë–ü–§", "—á–µ—Ä–µ–∑ –ü–§", "–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ"]
    marks = ['--', '-.', ':']
    for i in range(len(x)):
        label, mark = labels[i], marks[i]
        plt.plot(x[i], np.abs(y[i]), mark, label=label)
    plt.title("–ê–º–ø–ª–∏—Ç—É–¥–∞")
    plt.grid()
    plt.legend()

    fig2 = plt.figure(2)
    for i in range(len(x)):
        label, mark = labels[i], marks[i]
        plt.plot(x[i], np.angle(y[i]), mark, label=label)
    plt.title("–§–∞–∑–∞")
    plt.grid()
    plt.legend()

    plt.show()
    plt.close()


def plot_input_2D(x, y):
    fig1 = plt.figure(1)
    plt.plot(x, np.abs(y))
    plt.title("–ê–º–ø–ª–∏—Ç—É–¥–∞")
    plt.grid()

    fig2 = plt.figure(2)
    plt.plot(x, np.angle(y))
    plt.title("–§–∞–∑–∞")
    plt.grid()

    plt.show()
    plt.close()


def analitical_input_field_2d(x, a):
    return 1j * (2 * (np.pi * a * x + a) * np.cos(2 * a * (np.pi * x + 1)) - np.sin(2 * (np.pi * a * x + a))) / (
            2 * np.square(np.pi * x + 1))


def analitical_input_field_3d(x1, x2, a):
    return -(2 * (np.pi * a * x1 + a) * np.cos(2 * a * (np.pi * x1 + 1)) - np.sin(2 * (np.pi * a * x1 + a))) * \
           (2 * (np.pi * a * x2 + a) * np.cos(2 * a * (np.pi * x2 + 1)) - np.sin(2 * (np.pi * a * x2 + a))) \
           / (4 * np.square(np.pi * x1 + 1) * np.square(np.pi * x2 + 1))


def input_field_print_2d():
    global N, M, hx
    funct = input_field_2d
    x_f = np.linspace(-a, a, N)
    x_F = np.linspace(-b, b, N)

    f = funct(x_f)
    F = fin_fft_2d(hx, f)
    F1 = int_fourier_2d(x_f, x_F, hx, funct)
    F2 = analitical_input_field_2d(x_F, a)
    plot_all_2D((x_F, x_F, x_F), (F, F1, F2))

    plot_input_2D(x_f, f)


def plot_all_3d(xs, ys):
    labels = ["—á–µ—Ä–µ–∑ –ë–ü–§", "—á–µ—Ä–µ–∑ –ü–§", "–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ"]
    ops = [np.abs, np.angle]
    axises = ["abs", "angle"]
    for i in range(len(xs)):
        label = labels[i]
        x,x = np.meshgrid(xs[i],xs[i])
        for j in range(2):
            op, axis = ops[j], axises[j]
            target = op(ys[i])
            ax = plt.axes(projection='3d')
            ax.plot_surface(X=x, Y=x.T, Z=target, cmap='plasma', vmin=np.nanmin(target), vmax=np.nanmax(target))
            ax.set_xlabel('Œæ1')
            ax.set_xlabel('Œæ1')
            ax.set_xlabel(axis)
            plt.savefig(label + ' ' + axis + '.png')
            plt.show()
            plt.close()


def plot_input_3D(x_f, f):
    pass


def input_field_print_3d():
    funct = input_field_3d
    x_f = np.linspace(-a, a, N)
    y_f = np.linspace(-a, a, N)
    x_F = np.linspace(-b, b, N)

    x, y = np.meshgrid(x_f, y_f)
    X, Y = np.meshgrid(x_F, x_F)
    zf = funct(x, y)
    plt.imshow(np.abs(zf),extent=(-a,a,-a,a))
    plt.show()
    plt.imshow(np.angle(zf),extent=(-a,a,-a,a))
    plt.show()
    F = fin_fft_3d(hx, zf)
    plt.imshow(np.abs(F),extent=(-b,b,-b,b))
    #plt.show()
    F1 = int_fourier_3d(x_f, x_F, hx, input_field_2d)
    plt.imshow(np.abs(F1),extent=(-b,b,-b,b))
    #plt.show()
    F2 = analitical_input_field_3d(x_F[:, None], x_F[None, :], a)
    plt.imshow(np.abs(F2),extent=(-b,b,-b,b))
    #plt.show()

    plot_all_3d((x_F, x_F, x_F), (F, F1, F2))

    # plot_input_3D(x_f, zf)


def gaussian_print_2d():
    global N, M, hx
    funct = gaussian
    x_f = np.linspace(-a, a, N)
    x_F = np.linspace(-b, b, N)

    f = funct(x_f)
    F = fin_fft_2d(hx, f)
    F1 = int_fourier_2d(x_f, x_F, hx, funct)
    plot_all_2D((x_F, x_F), (F, F1))

    plot_input_2D(x_f, f)


def gaussian_print_3d():
    funct = gaussian_3d
    x_f = np.linspace(-a, a, N)
    y_f = np.linspace(-a, a, N)
    x_F = np.linspace(-b, b, N)

    zf = funct(x_f[:, None], y_f[None, :])
    plt.imshow(zf)
    #plt.show()
    F = fin_fft_3d(hx, zf)
    plt.imshow(np.abs(F))
    #plt.show()
    F1 = int_fourier_3d(x_f, x_F, hx, gaussian)
    plt.imshow(np.abs(F1))
    #plt.show()
    x, y = np.meshgrid(x_f, x_f)
    F2 = analitical_input_field_3d(x, y, a)
    plt.imshow(np.abs(F))


def main():
    #input_field_print_3d()
    input_field_print_3d()


if __name__ == '__main__':
    main()
